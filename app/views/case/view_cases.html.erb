
<style>
  .table-cell{
      width: 50%;
      padding: 4px;
      padding-left: 30px !important;
      color: darkslategray;
  }
  .btn{
      min-width: 100px;
      margin-left: 10px;
  }
  .dynamic-button{
      margin-left: 15px;
      margin-right: 25px;
  }
  .summary{

      margin-bottom: 1%;

  }
  .summary td {

      background: #ffffff;
      text-align: left !important;
      padding: 5px;
      padding-left: 10px;
      border: 1px solid lightslategrey;

  }
  .clickable{

      font-weight: bold;
  }
    th{
        padding: 8px;
    }
</style>

<%
    @available_printers = YAML.load_file("#{Rails.root}/config/couchdb.yml")[Rails.env]['printer_name'].split(',') rescue []
    @tasks = ActionMatrix.read(@current_user.role, @statuses)
%>

<div style="background: white">
  <div style="height: 535px; overflow: auto;padding: 0px; margin:0px;">
<table class="summary" id="summary" style="">
      
      <tr>
        <th colspan="11">Section 1 : Particulars of the deceased</th>
      </tr>

      <tr>
        <td rowspan="12" style="background-color:#dbdada;">PART 1 <br/>PERSONAL DETAILS OF DECEASED</td>
        <td>1</td>
        <td  class="clickable" onclick="editField('last_name')">Surname</td>
        <td colspan="2" ><%= @person.last_name %></td>
        <td class="clickable" onclick="editField('first_name')" >First name</td>
        <td  colspan="1"><%= @person.first_name %></td>
        <td class="clickable" onclick="editField('middle_name')" >Other</td>
        <td colspan="1"><%= @person.middle_name rescue "" %></td>
        <td class="clickable" >Barcode No.</td>
        <td colspan="1"><%= @person.barcode rescue "" %></td>
      </tr>
      <tr>
        <td>2</td>
        <td class="clickable" onclick="editField('id_number')" >ID No.</td>
        <td style="border-bottom :1.5px solid black"><%= @person.id_number rescue ""%></td>
        <td>3</td>
        <td class="clickable" onclick="editField('nationality')">Nationality</td>
        <td colspan="2" style="border-bottom :1.5px solid black"><%= @person.nationality rescue ""%></td>
        <td>4</td>
        <td class="clickable" onclick="editField('gender')">Sex</td>
        <td style="border-bottom:1.5px solid black"> <%= @person.gender %></td>
      </tr>
      <tr>
        <td>5</td>
        <td class="clickable" onclick="editField('birthdate')" >Birth Date</td>
        <td style="border-bottom: 1.5px solid black" colspan="5"><%= Date.parse(@person.birthdate.to_s).strftime("%d/%b/%Y") %></td>
        <td rowspan="2">6</td>
        <td rowspan="2" class="clickable" onclick="editField('birth_certificate_number')" >Birth certificate No.</td>
        <td rowspan="2" style="border-bottom :1.5px solid black"><%= @person.birth_certificate_number %></td>
      </tr>
      <tr>
        <td>7</td>
        <td class="clickable" onclick="editField('date_of_death')" >Date of Death</td>
        <td style="border-bottom: 1.5px solid black" colspan="5"><%= Date.parse(@person.date_of_death.to_s).strftime("%d/%b/%Y") %></td>
      </tr>
      <tr>
        <td rowspan="4">8</td>
        <td class="clickable" onclick="editField('place_of_death')" >Place of Death</td>
        <td colspan="9"><%= @person.place_of_death %></td>
      </tr>
      <tr>
        <td class="clickable" onclick="editField('hospital_of_death')" >Health Facility</td>
        <td colspan="8" style="border-bottom: 1.5px solid black"> <%= @person.hospital_of_death %></td>
      </tr>
      <tr>
        <td class="clickable" onclick="editField('hospital_of_death')" >Home</td>
        <td>Address</td>
        <td class="clickable" onclick="editField('home_district')" >District</td>
        <td style="border-bottom:1.5px solid black"><%= @person.place_of_death_district %></td>
        <td class="clickable" onclick="editField('home_district')">TA</td>
        <td style="border-bottom:1.5px solid black"><%= @person.place_of_death_ta %></td>
        <td class="clickable" onclick="editField('home_district')" >Village</td>
        <td style="border-bottom:1.5px solid black" colspan="2"><%= @person.place_of_death_village %></td>
      </tr>
      <tr>
        <td>Other</td>
        <td colspan="8"><%= @person.other_place_of_death rescue '' %></td>
      </tr>
      <tr>
        <td>9</td>
        <td colspan="3">Physical residential address</td>
        <td class="clickable" onclick="editField('current_district')" >District </td>
        <td><%= @person_place_details['current_district'] %></td>
        <td class="clickable" onclick="editField('current_ta')">TA</td>
        <td><%= @person_place_details['current_ta'] %></td>
        <td class="clickable" onclick="editField('current_village')" >Village</td>
        <td><%= @person_place_details['current_village'] %></td>
      </tr>
      <tr>
        <td>10</td>
        <td colspan="3">Home address</td>
        <td class="clickable" onclick="editField('home_district')" >District </td>
        <td><%= @person_place_details['home_district'] %></td>
        <td class="clickable" onclick="editField('home_ta')">TA</td>
        <td><%= @person_place_details['home_ta'] %></td>
        <td class="clickable" onclick="editField('home_village')" >Village</td>
        <td><%= @person_place_details['home_village'] %></td>
      </tr>
      <tr>
        <td rowspan="2">11</td>
        <td colspan="8" class="clickable" onclick="editField('died_while_pregnant')" >In case this is a female death, did the death occur while pregnant, at the time of delivery or within 6 weeks after the end of pregnancy?</td>
        <td><%= @person.died_while_pregnant rescue "No" %></td>
      </tr>
      <tr>
        
        <td colspan="9"></td>
      </tr>
      <tr>
        <td rowspan="6">PART 2 <br/><br/>DETAILS OF PARENT</td>
        <td rowspan="3">1</td>
        <td colspan="6" class="clickable" onclick="editField('mother_name')" >Mother's name</td>
        <td rowspan="3">2</td>
        <td rowspan="3" class="clickable" onclick="editField('mother_id_number')">ID No.</td>
        <td rowspan ="3" style="border-bottom:1.5px solid black"><%= @person.mother_id_number %></td>
      </tr>
      <tr>
        <td class="clickable" onclick="editField('mother_last_name')" >Surname</td>
        <td colspan="2"><%= @person.mother_last_name %></td>
        <td class="clickable" onclick="editField('mother_first_name')" >First name</td>
        <td colspan="2"><%= @person.mother_first_name %></td>
      </tr>
      <tr>
        <td class="clickable" onclick="editField('mother_middle_name')">Other names</td>
        <td colspan="5"><%= @person.mother_middle_name %></td>
      </tr>
      <tr>
        <td rowspan="3">3</td>
        <td colspan="6" class="clickable" onclick="editField('father_id_number')">Father's name</td>
        <td rowspan="3">4</td>
        <td rowspan="3" class="clickable" onclick="editField('father_id_number')">ID No.</td>
        <td rowspan ="3" style="border-bottom:1.5px solid black"><%= @person.father_id_number %></td>
      </tr>
      <tr>
        <td class="clickable" onclick="editField('father_last_name')">Surname</td>
        <td colspan="2"><%= @person.father_last_name %></td>
        <td class="clickable" onclick="editField('father_first_name')">First name</td>
        <td colspan="2"><%= @person.father_first_name %></td>
      </tr>
      <tr>
        <td class="clickable" onclick="editField('father_middle_name')">Other names</td>
        <td colspan="5"><%= @person.father_middle_name %></td>
      </tr>

      <tr>
        <td rowspan="7" style="background-color:#dbdada;">PART 3 <br/>INFORMANTS DETAILS</td>
        <td rowspan="2">1</td>
        <td class="clickable" onclick="editField('informant_last_name')" >Surname</td>
        <td colspan="2"><%= @person.informant_last_name %></td>
        <td class="clickable" onclick="editField('informant_first_name')">First name</td>
        <td colspan="2"><%= @person.informant_first_name %></td>
        <td rowspan="2">2</td>
        <td rowspan="2" class="clickable" onclick="editField('informant_id_number')">ID No.</td>
        <td rowspan="2"><%= @person.informant_id_number %></td>
      </tr>
      <tr>
        <td class="clickable" onclick="editField('informant_middle_name')">Other name</td>
        <td colspan="5"><%= @person.informant_middle_name %></td>
      </tr>
      <tr>
        <td>3</td>
        <td class="clickable" onclick="editField('informant_relationship_to_deceased')">Relation to the deceased</td>
        <td colspan="8">
          <%= @person.informant_relationship_to_deceased rescue @person.informant_relationship_to_deceased_other %>
        </td>
      </tr>
      <tr>
        <td rowspan="2">4</td>
        <td><b>Address</b></td>
        <td class="clickable" onclick="editField('informant_current_district')">District</td>
        <td colspan="2"><%= @person_place_details['informant_current_district'] %></td>
        <td class="clickable" onclick="editField('informant_current_ta')">TA</td>
        <td colspan="2"><%= @person_place_details['informant_current_ta'] %></td>
        <td class="clickable" onclick="editField('informant_current_village')">Village</td>
        <td><%= @person_place_details['informant_current_village'] %></td>
      </tr>
      <tr>
        <td class="clickable" onclick="editField('informant_address')">Postal address :</td>
        <td colspan="6">
          <%= @person.informant_addressline1 rescue "" %>
          <%= " #{@person.informant_city}" rescue "" %> 
        </td>
        <td class="clickable" onclick="editField('informant_phone_number')">Telephone Number</td>
        <td><%= @person.informant_phone_number %></td>
      </tr>
      <tr>
        <td rowspan="2">5</td>
        <th colspan="9" style="background: #ffffff; color:black">I certify that the above information is correct and I am aware that I could face criminal prosecution if this information is incorrect in material respect.</th>
      </tr>
      <tr>
        <td>Date:</td>
        <td colspan="8"><%= Date.parse(@person.informant_signature_date.to_s).strftime("%d/%b/%Y") rescue "" %></td>
      </tr>
    </table>

      <%= render :partial=>"/hq/section2" %>
  </div>

  <div class="table-container-footer" style="padding: 0px;margin-bottom: 0px;">
    <table class="table table-striped table-hover table-condensed table-bordered">
      <tfoot>
      <tr>
        <th colspan="2" style="padding-left: 10px !important;">
          <%
             comment = false
            cancel_url = request.referrer
            cancel_url = "/" if (!cancel_url.match('case/') rescue true)
          %>

          <div onclick= "window.parent.location = '<%= cancel_url%>' " class="dynamic-button btn btn-small btn-default pull-left btn-danger"><span>Cancel</span></div>

          <% @tasks.each do |task|
            onclick = ''

            if task['route']
                onclick = "window.parent.location = '" + task['route'] + "&person_id=" + @person.id + "'"
            elsif task['ajax_route']
                onclick = "ajaxify('#{task['ajax_route']}')"
            elsif task['popup']
                onclick = "loadPopup('#{task['popup']}')"
            end
            next if task['button_name'].blank?

            if ((task['ajax_route'].match(/comment/) || task['route'].match(/comment/)) rescue false)
                comment = true
            end
          %>

              <div onclick= "<%= onclick %>" class="dynamic-button btn btn-small btn-primary pull-right <%= task['class'].downcase rescue ''%>"><span><%= task['button_name']%></span></div>
          <% end %>

          <% if comment == true && false%>
            <div onclick= "ajaxPullComments()" class="dynamic-button btn btn-small btn-primary pull-right primary"><span>View Comments</span></div>
          <% end %>
          <div id="comment_div" onclick= "ajaxPullComments()" class="dynamic-button btn btn-small btn-primary pull-right primary" style="visibility: hidden;"><span>View Comments</span></div>
        </th>
      </tr>
      </tfoot>
    </table>
  </div>
</div>


<div class="" id="printers">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header btn-primary" >
        <button type="button" class="close"  onclick="__$('printers').style.display = 'none'">
          <span aria-hidden="true">&times;</span>
          <span class="sr-only">Close</span>
        </button>
        <h4 class="modal-title">Select a printer</h4>
      </div>
      <div class="modal-body">

        <div class="row">
          <div class="col-lg-12">
            <table class="table table-condensed table-striped table-hover">
              <tbody>
                <% @available_printers.each do |printer| %>
                    <tr onmousedown="updateValue(this)" value="<%= printer %>" class="table-row" style="cursor: pointer">
                      <td class="table-cell"><input type="radio" class="printer_radio_button" value="<%= printer %>" name="printer_name"/></td>
                      <td class="table-cell" style="text-align: left; padding-left:50px;"><%= printer %></td>
                    </tr>
                <% end %>
              </tbody>
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="__$('frm').submit()" > Print </button>
            <button type="button" class="btn btn-default" onclick="__$('printers').style.display = 'none'" > Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="" id="completeness">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header btn-primary" >
        <button type="button" class="close"  onclick="__$('completeness').style.display = 'none'">
          <span aria-hidden="true">&times;</span>
          <span class="sr-only">Close</span>
        </button>
        <h4 class="modal-title">Completeness Check</h4>
      </div>
      <div class="modal-body">

        <div class="row">
          <div class="col-lg-12">

            <div class=" form-group">
              <table class="table table-condensed table-striped table-bordered table-hover">
                <tbody>
                    <tr class="table-row">
                        <th class="table-cell">First Name</th>
                        <td class="table-cell"><%= @person.first_name%></td>
                    </tr>

                    <tr class="table-row">
                      <th class="table-cell">Last Name</th>
                      <td class="table-cell"><%= @person.last_name%></td>
                    </tr>

                    <tr class="table-row">
                      <th class="table-cell">Sex</th>
                      <td class="table-cell"><%= @person.gender%></td>
                    </tr>

                    <tr class="table-row">
                      <th class="table-cell">Date of Birth</th>
                      <td class="table-cell"><%= @person.birthdate.to_date.strftime('%d/%b/%Y') rescue nil%></td>
                    </tr>

                    <tr class="table-row">
                      <th class="table-cell">Date of Death</th>
                      <td class="table-cell"><%= @person.date_of_death.to_date.strftime('%d/%b/%Y') rescue nil%></td>
                    </tr>

                    <tr class="table-row">
                      <th class="table-cell">Informant First Name</th>
                      <td class="table-cell"><%= @person.informant_first_name%></td>
                    </tr>

                    <tr class="table-row">
                      <th class="table-cell">Informant Last Name</th>
                      <td class="table-cell"><%= @person.informant_last_name%></td>
                    </tr>

                    <tr class="table-row">
                      <th class="table-cell">Informant Signed</th>
                      <td class="table-cell"><%= @person.informant_signed%></td>
                    </tr>
                </tbody>
              </table>
            </div>
          </div>
      <div class="modal-footer">
        <%@next_state ={
                "Data Checking Clerk" => ["HQ COMPLETE", "HQ POTENTIAL INCOMPLETE"],
                "Data Supervisor" => ["HQ CONFLICT", "HQ INCOMPLETE"],
                "Data Manager" => ["HQ PRINT", "HQ CONFIRMED INCOMPLETE"]
        }%>

        <button type="button" class="btn btn-success" onclick="ajaxChange('<%= @next_state[@current_user.role][0] rescue nil%>')" > Complete </button>
        <button type="button" class="btn btn-danger"onclick="ajaxChange('<%= @next_state[@current_user.role][1] rescue nil%>')" > Incomplete </button>
        <button type="button" class="btn btn-default" onclick="__$('completeness').style.display = 'none'" > Close</button>
      </div>
    </div>
  </div>
</div>
</div>
</div>

<div class="" id="comments">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header btn-primary">
        <h4 class="modal-title">Death Record Comments</h4>
      </div>
      <div class="modal-body">

        <div class="row">
          <div class="col-lg-12">

            <div class=" form-group">
              <div class="container">
                <div class="row" style="width: 550px;">

                    <div id="comments-list">

                    </div>

                    <div style="width: 100%;margin-top: 20px;border-top: 1px solid #d3d3d3">
                        <form id="comment-form" action="/ajax_save_comment">
                          <textarea class="form-control" name="comment" placeholder="New Comment" id="textarea" style="width: 98%;margin-top: 4px;margin-bottom: 4px;"></textarea>

                          <div onclick="saveComment();" class="btn btn-sm btn-primary pull-left">Submit</div>
                        </form>
                    </div>
                  </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="comment_close" type="button" class="btn btn-sm btn-default" onclick="__$('textarea').value = '';
                    __$('comments').style.display = 'none'" > Finish </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="clone_me" class="media" style="padding: 5px;display:none;border-top: 1px solid lightgrey;">
  <div class="media-body" style="width: 550px;">
    <h4 class="media-heading user_name"><a class="name"> <small class="role"> </small></a></h4>
    <span class="comment" style="width: 100%;"></span>
  </div>
</div>

<%= form_tag("/do_print_these", "method" => "post", "id" => "frm") do %>
    <input type="hidden" id="selected" name="selected" value="<%= params[:person_id]%>"/>
    <input type="hidden" id="printer_name" name="printer_name" value=""/>
<% end %>

<script>
    var next_status ="";
    function loadPopup(id){
        __$(id).style.display = "block";
    }

    function __$(id){
        return document.getElementById(id);
    }

    function ___$(clas){
        return document.getElementsByClassName(clas)[0];
    }

    function updateValue(obj){
        obj.getElementsByTagName('input')[0].checked = true
        __$("printer_name").value = obj.getAttribute('value');
    }

    function selectPrinter(){
        __$("printer_name").value = '';
        $(".printer_radio_button").prop( "checked", false );
    }

    function ajaxChange(status){
        $.ajax({
            url: "/ajax_change_status?next_status=" + status + "&person_id=<%=params['person_id']%>",
            success: function(feedback){
                jQuery(".modal-dialog").parent().hide();

                var status_arr = ["HQ INCOMPLETE", "HQ POTENTIAL INCOMPLETE", "HQ CONFIRMED INCOMPLETE",
                    "HQ POTENTIAL DUPLICATE", "HQ DUPLICATE", "HQ CONFIRMED DUPLICATE", "HQ VOID", "HQ REOPEN",
                    "HQ AMMEND"
                ];

                if(status_arr.indexOf(status) >= 0){
                    var link = "<%= (session[:return_url] || '/')%>".trim();
                    next_status = status;
                    ajaxPullComments(link);
                }else {
                    window.parent.location = "<%= (session[:return_url] || request.referrer)%>";
                }
            },
            error: function(error){
                alert("Something went wrong!");
            }
        })
    }

    function ajaxify(route, btn){
        $.ajax({
            url: route + "&person_id=<%=params['person_id']%>",
            success: function(feedback){
                window.parent.location = "<%= session[:return_url] || request.referrer%>";
            },
            error: function(error){
                alert("Something went wrong!");
            }
        })
    }

    function ajaxPullComments(link){
        jQuery("#comment-list").html("");

        jQuery.ajax(
                {
                    url: "/get_comments?person_id=<%= params[:person_id]%>",
                    success: function(results){
                        results = JSON.parse(results);
                        var parent = document.getElementById("comments-list");
                        parent.innerHTML = "";
                        var clone = document.getElementById("clone_me");
                        for(var i = 0; i < results.length; i++){
                            var dup = clone.cloneNode(true);
                            dup.id = i;
                            dup.style.display = "block";
                            //set values
                            dup.getElementsByClassName("name")[0].innerHTML = results[i]['user']
                                    + " <small class='user_role'>" + results[i]['user_role'] + " - " + results[i]['date_added'] + " </small>";
                            dup.getElementsByClassName("comment")[0].innerHTML = results[i]['comment'];

                            parent.appendChild(dup);
                        }

                        jQuery("#comments").show();

                        parent.scrollTop = parent.scrollHeight;

                        document.getElementById("comment_close").onmousedown = function(){
                            if(link){
                                window.parent.location = link;
                            }else{
                                window.parent.location = "/";
                            }
                        }
                    },
                    error: function(e){
                        alert("Something went wrong!")
                    }
                }
        )
    }

    function saveComment(){
        var url = "/ajax_save_comment?person_id=<%= params[:person_id]%>&next_status="+next_status+"&comment="
        jQuery.ajax(
                {
                    url: url,
                    data: {
                        'comment' : __$("textarea").value,
                        "authenticity_token": "<%= form_authenticity_token %>"
                    },
                    success: function(result){
                        console.log(url);
                        result = JSON.parse(result);
                        var parent = document.getElementById("comments-list");
                        var clone = document.getElementById("clone_me");

                        var dup = clone.cloneNode(true);

                        dup.style.display = "block";
                        //set values
                        dup.getElementsByClassName("name")[0].innerHTML = result['user']
                                + " <small class='user_role'>" + result['user_role'] + " - " + result['date_added'] + " </small>";
                        dup.getElementsByClassName("comment")[0].innerHTML = result['comment'];
                        dup.style.background = "lightblue";

                        parent.appendChild(dup);
                        parent.scrollTop = parent.scrollHeight;
                        __$("textarea").value = "";
                       // alert("Comment Added Successfully")
                    },
                    error: function(){
                        alert("Something went wrong!")
                    }
                }
        )
    }
    $(document).ready(function(){
        jQuery.ajax(
                {
                    url: "/get_comments?person_id=<%= params[:person_id]%>",
                    success: function(results){
                        results = JSON.parse(results);
                        if(results.length > 0){
                            console.log($("#comment_div"));
                            $("#comment_div").css("visibility", "visible"); 
                        }
                    },
                    error: function(e){
                        alert("Something went wrong!")
                    }
                }
        )
    });
</script>
<style>
  #completeness, #printers, #comments{
      position : absolute;
      left: 30%;
      top: 13.5%;
      display: none;
  }

  .user_name{
      font-size:14px;
      font-weight: bold;
  }
  .comments-list .media{
      border-bottom: 1px dotted #ccc;
  }
  #comments-list{
      max-height: 300px;
      overflow: auto;
      width: 100%;
  }
</style>
